{% extends 'base.html' %}

{% block title %}Billing Dashboard - NeuroStock{% endblock %}

{% block content %}
<div class="container-fluid">
    <h2>CSV Billing Test</h2>
    
    <div class="card">
        <div class="card-body">
            <h5>Upload CSV File</h5>
            <form>
                {% csrf_token %}
                <input type="file" id="csv-file" accept=".csv" class="form-control mb-3">
                <button type="button" onclick="testUpload()" class="btn btn-primary">Test Upload</button>
            </form>
            
            <div id="result" class="mt-3"></div>
        </div>
    </div>
</div>

<script>
function testUpload() {
    console.log('testUpload called');
    alert('Button works!');
    
    const fileInput = document.getElementById('csv-file');
    const file = fileInput.files[0];
    
    if (!file) {
        alert('Please select a file');
        return;
    }
    
    console.log('File selected:', file.name);
    
    const formData = new FormData();
    formData.append('complete_csv_file', file);
    
    // Get CSRF token
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
    if (csrfToken) {
        formData.append('csrfmiddlewaretoken', csrfToken.value);
        console.log('CSRF token found and added');
    } else {
        console.error('CSRF token not found');
        alert('CSRF token not found');
        return;
    }
    
    console.log('Sending request to /load-complete-csv/');
    
    fetch('/load-complete-csv/', {
        method: 'POST',
        body: formData
    })
    .then(response => {
        console.log('Response status:', response.status);
        console.log('Response headers:', response.headers);
        
        // Check if response is JSON
        const contentType = response.headers.get('content-type');
        if (contentType && contentType.includes('application/json')) {
            return response.json();
        } else {
            // If not JSON, get text to see what was returned
            return response.text().then(text => {
                throw new Error(`Server returned HTML instead of JSON. Status: ${response.status}. Content: ${text.substring(0, 200)}...`);
            });
        }
    })
    .then(data => {
        console.log('Response:', data);
        document.getElementById('result').innerHTML = '<pre>' + JSON.stringify(data, null, 2) + '</pre>';
    })
    .catch(error => {
        console.error('Error:', error);
        document.getElementById('result').innerHTML = '<div class="alert alert-danger">Error: ' + error.message + '</div>';
    });
}
</script>
{% endblock %}