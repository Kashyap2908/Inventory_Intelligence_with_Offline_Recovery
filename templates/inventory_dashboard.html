{% extends 'base.html' %}
{% load tz %}

{% block title %}Inventory Dashboard - NeuroStock{% endblock %}

{% block nav %}
    <nav class="navbar navbar-expand-lg">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="fas fa-brain me-2"></i>NeuroStock
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    {% if user.userprofile.role == 'inventory' %}
                        <!-- Inventory users: Inventory + Billing -->
                        <li class="nav-item">
                            <a class="nav-link" href="{% url 'inventory_dashboard' %}">
                                <i class="fas fa-warehouse me-1"></i>Inventory
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="{% url 'billing' %}">
                                <i class="fas fa-receipt me-1"></i>Billing
                            </a>
                        </li>
                    {% elif user.userprofile.role == 'admin' %}
                        <!-- Admin users: Inventory + Trends + Billing + Admin -->
                        <li class="nav-item">
                            <a class="nav-link" href="{% url 'inventory_dashboard' %}">
                                <i class="fas fa-warehouse me-1"></i>Inventory
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="{% url 'trend_dashboard' %}">
                                <i class="fas fa-chart-line me-1"></i>Trends
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="{% url 'billing' %}">
                                <i class="fas fa-receipt me-1"></i>Billing
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="{% url 'admin_dashboard' %}">
                                <i class="fas fa-cog me-1"></i>Admin
                            </a>
                        </li>
                    {% elif user.userprofile.role == 'marketing' %}
                        <!-- Marketing users: Only Trends -->
                        <li class="nav-item">
                            <a class="nav-link" href="{% url 'trend_dashboard' %}">
                                <i class="fas fa-chart-line me-1"></i>Trends
                            </a>
                        </li>
                    {% else %}
                        <!-- Fallback: Show inventory + billing -->
                        <li class="nav-item">
                            <a class="nav-link" href="{% url 'inventory_dashboard' %}">
                                <i class="fas fa-warehouse me-1"></i>Inventory
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="{% url 'billing' %}">
                                <i class="fas fa-receipt me-1"></i>Billing
                            </a>
                        </li>
                    {% endif %}
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item dropdown me-3">
                        <a class="nav-link position-relative" href="#" id="notificationDropdown" role="button" 
                           onclick="showNotifications()">
                            <i class="fas fa-bell"></i>
                            {% if total_notifications > 0 %}
                            <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                                {{ total_notifications }}
                            </span>
                            {% endif %}
                        </a>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-user me-1"></i>{{ user.username }}
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="{% url 'logout' %}">
                                <i class="fas fa-sign-out-alt me-1"></i>Logout
                            </a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
{% endblock %}

{% block content %}
<!-- Header with Quick Stats -->
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h2 class="mb-1">Inventory Management</h2>
                <p class="text-muted mb-0">Manage products and stock entries</p>
            </div>
        </div>
    </div>
</div>

<!-- Main Dashboard Tabs -->
<div class="row">
    <div class="col-12">
        <div class="card shadow-sm">
            <div class="card-header bg-light">
                <ul class="nav nav-tabs card-header-tabs" id="mainTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="notifications-tab" data-bs-toggle="tab" data-bs-target="#notifications-panel" type="button" role="tab">
                            <i class="fas fa-bell me-2"></i>Notifications
                            {% if total_notifications > 0 %}
                                <span class="badge bg-danger ms-1">{{ total_notifications }}</span>
                            {% endif %}
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="forms-tab" data-bs-toggle="tab" data-bs-target="#forms-panel" type="button" role="tab">
                            <i class="fas fa-plus me-2"></i>Add Items
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="products-tab" data-bs-toggle="tab" data-bs-target="#products-panel" type="button" role="tab">
                            <i class="fas fa-list me-2"></i>Products Overview
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="history-tab" data-bs-toggle="tab" data-bs-target="#history-panel" type="button" role="tab">
                            <i class="fas fa-history me-2"></i>Recent Activity
                        </button>
                    </li>
                </ul>
            </div>
            <div class="card-body">
                <div class="tab-content" id="mainTabContent">
                    
                    <!-- Notifications Panel -->
                    <div class="tab-pane fade show active" id="notifications-panel" role="tabpanel">
                        <div class="row">
                            <div class="col-12">
                                <!-- Sub-tabs for notifications -->
                                <ul class="nav nav-pills mb-3" id="notificationTabs" role="tablist">
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link active" id="new-notifications-tab" data-bs-toggle="pill" data-bs-target="#new-notifications" type="button" role="tab">
                                            <i class="fas fa-bell me-1"></i>New ({{ total_notifications }})
                                        </button>
                                    </li>
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link" id="read-notifications-tab" data-bs-toggle="pill" data-bs-target="#read-notifications" type="button" role="tab">
                                            <i class="fas fa-check-circle me-1"></i>Read ({{ read_notifications|length }})
                                        </button>
                                    </li>
                                </ul>
                                
                                <div class="tab-content" id="notificationTabContent">
                                    <!-- New Notifications -->
                                    <div class="tab-pane fade show active" id="new-notifications" role="tabpanel">
                                        {% if notifications %}
                                            <div class="row">
                                                {% for notification in notifications %}
                                                <div class="col-lg-6 mb-3">
                                                    <div class="card h-100 border-start border-4 
                                                         {% if notification.notification_type == 'admin_message' %}border-primary bg-light
                                                         {% elif notification.priority == 'urgent' %}border-danger
                                                         {% elif notification.priority == 'high' %}border-warning
                                                         {% elif notification.priority == 'medium' %}border-info
                                                         {% else %}border-secondary{% endif %}" data-notification-id="{{ notification.id }}">
                                                        <div class="card-body p-3">
                                                            {% if notification.notification_type == 'admin_message' %}
                                                            <div class="d-flex align-items-center mb-2">
                                                                <div class="badge bg-primary me-2">
                                                                    <i class="fas fa-user-shield me-1"></i>ADMIN MESSAGE
                                                                </div>
                                                                <span class="badge bg-{{ notification.priority }}">{{ notification.priority|upper }}</span>
                                                            </div>
                                                            {% endif %}
                                                            <div class="d-flex justify-content-between align-items-start mb-2">
                                                                <h6 class="card-title mb-0 
                                                                    {% if notification.notification_type == 'admin_message' %}text-primary fw-bold
                                                                    {% elif notification.priority == 'urgent' %}text-danger
                                                                    {% elif notification.priority == 'high' %}text-warning
                                                                    {% elif notification.priority == 'medium' %}text-info
                                                                    {% else %}text-primary{% endif %}">
                                                                    {% if notification.notification_type == 'admin_message' %}
                                                                        <i class="fas fa-envelope me-1"></i>
                                                                    {% elif notification.priority == 'urgent' %}
                                                                        <i class="fas fa-fire me-1"></i>
                                                                    {% elif notification.priority == 'high' %}
                                                                        <i class="fas fa-exclamation-triangle me-1"></i>
                                                                    {% elif notification.priority == 'medium' %}
                                                                        <i class="fas fa-info-circle me-1"></i>
                                                                    {% else %}
                                                                        <i class="fas fa-bell me-1"></i>
                                                                    {% endif %}
                                                                    {{ notification.title }}
                                                                </h6>
                                                                {% if notification.notification_type != 'admin_message' %}
                                                                <span class="badge 
                                                                    {% if notification.priority == 'urgent' %}bg-danger
                                                                    {% elif notification.priority == 'high' %}bg-warning text-dark
                                                                    {% elif notification.priority == 'medium' %}bg-info
                                                                    {% else %}bg-secondary{% endif %}">
                                                                    {{ notification.priority|upper }}
                                                                </span>
                                                                {% endif %}
                                                            </div>
                                                            <p class="card-text small text-muted mb-2">{{ notification.message|truncatewords:15 }}</p>
                                                            {% if notification.product %}
                                                            <div class="small text-info mb-2">
                                                                <i class="fas fa-box me-1"></i>{{ notification.product.name }}
                                                                <span class="ms-2 text-muted">Stock: {{ notification.product.total_stock }} units</span>
                                                            </div>
                                                            {% endif %}
                                                            <div class="small text-muted mb-3">
                                                                <i class="fas fa-clock me-1"></i>{% timezone "Asia/Kolkata" %}{{ notification.created_at|date:"M d, H:i" }}{% endtimezone %}
                                                            </div>
                                                            <div class="d-flex gap-1 flex-wrap">
                                                                {% if notification.notification_type == 'admin_message' %}
                                                                    <button class="btn btn-sm btn-primary" onclick="showFullMessage('{{ notification.id }}')" title="View Full Message">
                                                                        <i class="fas fa-eye me-1"></i>View Details
                                                                    </button>
                                                                    <button class="btn btn-sm btn-success mark-read-btn" data-notification-id="{{ notification.id }}" title="Mark as read">
                                                                        <i class="fas fa-check me-1"></i>Acknowledge
                                                                    </button>
                                                                {% elif notification.notification_type == 'order_request' %}
                                                                    <button class="btn btn-sm btn-warning receive-order-btn" 
                                                                            data-notification-id="{{ notification.id }}" 
                                                                            title="Acknowledge Order Request">
                                                                        <i class="fas fa-handshake"></i> Receive
                                                                    </button>
                                                                    <button class="btn btn-sm btn-info update-order-btn" 
                                                                            data-notification-id="{{ notification.id }}"
                                                                            data-product-name="{{ notification.product.name }}"
                                                                            title="Mark as Ordered">
                                                                        <i class="fas fa-truck"></i> Ordered
                                                                    </button>
                                                                {% else %}
                                                                    <button class="btn btn-sm btn-success mark-read-btn" data-notification-id="{{ notification.id }}" title="Mark as read">
                                                                        <i class="fas fa-check"></i> Read
                                                                    </button>
                                                                {% endif %}
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                {% endfor %}
                                            </div>
                                        {% else %}
                                            <div class="text-center py-5">
                                                <i class="fas fa-bell-slash fa-3x text-muted mb-3"></i>
                                                <h5 class="text-muted">No new notifications</h5>
                                                <p class="text-muted">You're all caught up!</p>
                                            </div>
                                        {% endif %}
                                    </div>
                                    
                                    <!-- Read Notifications -->
                                    <div class="tab-pane fade" id="read-notifications" role="tabpanel">
                                        {% if read_notifications %}
                                            <div class="row">
                                                {% for notification in read_notifications %}
                                                <div class="col-lg-6 mb-3">
                                                    <div class="card h-100 border-start border-4 border-success opacity-75">
                                                        <div class="card-body p-3">
                                                            <div class="d-flex justify-content-between align-items-start mb-2">
                                                                <h6 class="card-title mb-0 text-muted">
                                                                    <i class="fas fa-check-circle text-success me-1"></i>
                                                                    {{ notification.title }}
                                                                </h6>
                                                                <span class="badge bg-success">READ</span>
                                                            </div>
                                                            <p class="card-text small text-muted mb-2">{{ notification.message|truncatewords:15 }}</p>
                                                            {% if notification.product %}
                                                            <div class="small text-info mb-2">
                                                                <i class="fas fa-box me-1"></i>{{ notification.product.name }}
                                                            </div>
                                                            {% endif %}
                                                            <div class="small text-muted">
                                                                <i class="fas fa-clock me-1"></i>Read: {% timezone "Asia/Kolkata" %}{{ notification.safe_updated_at|date:"M d, H:i" }}{% endtimezone %}
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                {% endfor %}
                                            </div>
                                        {% else %}
                                            <div class="text-center py-5">
                                                <i class="fas fa-history fa-3x text-muted mb-3"></i>
                                                <h5 class="text-muted">No notification history</h5>
                                                <p class="text-muted">Read notifications will appear here</p>
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Forms Panel -->
                    <div class="tab-pane fade" id="forms-panel" role="tabpanel">
                        <div class="row">
                            <div class="col-lg-6 mb-4">
                                <div class="card h-100">
                                    <div class="card-header bg-primary text-white">
                                        <h5 class="mb-0"><i class="fas fa-plus me-2"></i>Add New Product</h5>
                                    </div>
                                    <div class="card-body">
                                        <form method="post">
                                            {% csrf_token %}
                                            <div class="mb-3">
                                                {{ product_form.name.label_tag }}
                                                {{ product_form.name }}
                                            </div>
                                            <div class="mb-3">
                                                {{ product_form.category.label_tag }}
                                                {{ product_form.category }}
                                            </div>
                                            <div class="row">
                                                <div class="col-md-6 mb-3">
                                                    {{ product_form.cost_price.label_tag }}
                                                    {{ product_form.cost_price }}
                                                </div>
                                                <div class="col-md-6 mb-3">
                                                    {{ product_form.selling_price.label_tag }}
                                                    {{ product_form.selling_price }}
                                                </div>
                                            </div>
                                            <button type="submit" name="add_product" class="btn btn-primary w-100">
                                                <i class="fas fa-plus me-1"></i>Add Product
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-6 mb-4">
                                <div class="card h-100">
                                    <div class="card-header bg-success text-white">
                                        <h5 class="mb-0"><i class="fas fa-boxes me-2"></i>Add Stock</h5>
                                    </div>
                                    <div class="card-body">
                                        <form method="post" id="stockForm">
                                            {% csrf_token %}
                                            <div class="mb-3">
                                                {{ stock_form.product.label_tag }}
                                                {{ stock_form.product }}
                                                <div id="productInfo" class="mt-2" style="display: none;">
                                                    <div class="alert alert-info mb-2">
                                                        <div class="row">
                                                            <div class="col-md-6">
                                                                <strong><i class="fas fa-warehouse me-1"></i>Current Stock:</strong>
                                                                <span id="currentStock" class="badge bg-primary ms-1">0 units</span>
                                                            </div>
                                                            <div class="col-md-6">
                                                                <strong><i class="fas fa-shopping-cart me-1"></i>Pending Orders:</strong>
                                                                <span id="pendingOrders" class="badge bg-warning ms-1">0 orders</span>
                                                            </div>
                                                        </div>
                                                        <div id="orderDetails" class="mt-2" style="display: none;">
                                                            <small class="text-muted">
                                                                <i class="fas fa-info-circle me-1"></i>
                                                                <strong>Note:</strong> Adding stock will notify the admin who placed the order.
                                                            </small>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="mb-3">
                                                {{ stock_form.quantity.label_tag }}
                                                {{ stock_form.quantity }}
                                            </div>
                                            <div class="mb-3">
                                                {{ stock_form.expiry_date.label_tag }}
                                                {{ stock_form.expiry_date }}
                                            </div>
                                            <button type="submit" name="add_stock" class="btn btn-success w-100">
                                                <i class="fas fa-plus me-1"></i>Add Stock
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Products Panel -->
                    <div class="tab-pane fade" id="products-panel" role="tabpanel">
                        <div class="table-responsive">
                            <table class="table table-hover" id="products-table">
                                <thead class="table-light">
                                    <tr>
                                        <th><i class="fas fa-box me-1"></i>Product</th>
                                        <th><i class="fas fa-tag me-1"></i>Category</th>
                                        <th><i class="fas fa-rupee-sign me-1"></i>Cost Price</th>
                                        <th><i class="fas fa-rupee-sign me-1"></i>Selling Price</th>
                                        <th><i class="fas fa-rupee-sign me-1"></i>Current Price</th>
                                        <th><i class="fas fa-chart-bar me-1"></i>Class</th>
                                        <th><i class="fas fa-warehouse me-1"></i>Stock</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for product in products %}
                                    <tr data-product-id="{{ product.id }}">
                                        <td><strong>{{ product.name }}</strong></td>
                                        <td><span class="badge bg-light text-dark">{{ product.category }}</span></td>
                                        <td>‚Çπ{{ product.cost_price }}</td>
                                        <td>‚Çπ{{ product.selling_price }}</td>
                                        <td><strong class="text-success">‚Çπ{{ product.new_price }}</strong></td>
                                        <td>
                                            <span class="badge bg-{% if product.calculated_abc_classification == 'A' %}danger{% elif product.calculated_abc_classification == 'B' %}warning{% else %}secondary{% endif %}">
                                                {{ product.calculated_abc_classification }}
                                            </span>
                                        </td>
                                        <td>
                                            <span class="badge {% if product.total_stock < 10 %}bg-danger{% elif product.total_stock < 50 %}bg-warning text-dark{% else %}bg-success{% endif %}">
                                                {{ product.total_stock }} units
                                            </span>
                                        </td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="7" class="text-center text-muted py-4">
                                            <i class="fas fa-box-open fa-2x mb-2"></i>
                                            <br>No products available
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- History Panel -->
                    <div class="tab-pane fade" id="history-panel" role="tabpanel">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th><i class="fas fa-box me-1"></i>Product</th>
                                        <th><i class="fas fa-sort-numeric-up me-1"></i>Quantity</th>
                                        <th><i class="fas fa-calendar-alt me-1"></i>Expiry Date</th>
                                        <th><i class="fas fa-clock me-1"></i>Added On</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for stock in recent_stock %}
                                    <tr>
                                        <td><strong>{{ stock.product.name }}</strong></td>
                                        <td><span class="badge bg-info">{{ stock.quantity }} units</span></td>
                                        <td>{{ stock.expiry_date }}</td>
                                        <td>{% timezone "Asia/Kolkata" %}{{ stock.created_at|date:"M d, Y H:i" }}{% endtimezone %}</td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="4" class="text-center text-muted py-4">
                                            <i class="fas fa-history fa-2x mb-2"></i>
                                            <br>No recent stock entries
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Real-time clock for inventory
function updateInventoryTime() {
    const now = new Date();
    const timeString = now.toLocaleTimeString('en-US', {
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        hour12: true
    });
    
    const currentTimeElement = document.getElementById('current-time-inventory');
    if (currentTimeElement) {
        currentTimeElement.textContent = timeString;
    }
}

// Initialize inventory time updates
document.addEventListener('DOMContentLoaded', function() {
    updateInventoryTime();
    setInterval(updateInventoryTime, 1000);
});

// Notification System JavaScript - Isolated and Clean
(function() {
    'use strict';
    
    console.log('üöÄ Initializing notification system...');
    
    // Global functions for template usage
    window.showNotifications = function() {
        console.log('üîî Bell icon clicked');
        const panel = document.getElementById('notifications-panel');
        if (panel) {
            panel.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
    };
    
    // Initialize notification buttons when DOM is ready
    function initializeNotificationButtons() {
        console.log('üìÑ Initializing notification buttons...');
        
        const markReadButtons = document.querySelectorAll('.mark-read-btn');
        console.log(`üîç Found ${markReadButtons.length} mark-read buttons`);
        
        markReadButtons.forEach(function(button, index) {
            // Remove any existing listeners to prevent duplicates
            const newButton = button.cloneNode(true);
            button.parentNode.replaceChild(newButton, button);
            
            console.log(`üîß Setting up button ${index + 1}`);
            
            newButton.addEventListener('click', function(event) {
                event.preventDefault();
                event.stopPropagation();
                
                console.log('‚úÖ Mark as read button clicked!');
                
                const notificationId = this.getAttribute('data-notification-id');
                console.log('üìù Notification ID:', notificationId);
                
                if (!notificationId) {
                    alert('Error: No notification ID found');
                    return;
                }
                
                // Get CSRF token
                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
                if (!csrfToken) {
                    alert('Error: CSRF token not found. Please refresh the page.');
                    return;
                }
                
                console.log('üîê CSRF token found');
                
                // Show loading state
                const originalHTML = this.innerHTML;
                this.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                this.disabled = true;
                
                console.log('üì° Sending AJAX request...');
                
                // Create form data
                const formData = new FormData();
                formData.append('csrfmiddlewaretoken', csrfToken.value);
                formData.append('notification_id', notificationId);
                
                // Send AJAX request
                fetch('/inventory/', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => {
                    console.log('üì® Response status:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('üìä Response data:', data);
                    
                    if (data.success) {
                        console.log('‚úÖ Success! Moving notification to history...');
                        
                        // Find the notification card
                        const notificationCard = this.closest('.col-lg-6');
                        if (notificationCard) {
                            // Get notification data before removing
                            const cardBody = notificationCard.querySelector('.card-body');
                            const titleElement = cardBody.querySelector('.card-title');
                            const messageElement = cardBody.querySelector('.card-text');
                            
                            const notificationData = {
                                id: notificationId,
                                title: titleElement ? titleElement.textContent.trim() : 'Notification',
                                message: messageElement ? messageElement.textContent.trim() : '',
                                priority: 'medium' // Default priority for history
                            };
                            
                            // Smooth fade out animation
                            notificationCard.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
                            notificationCard.style.opacity = '0';
                            notificationCard.style.transform = 'translateX(100%)';
                            
                            setTimeout(() => {
                                // Remove from new notifications
                                notificationCard.remove();
                                
                                // Add to history tab
                                addToNotificationHistory(notificationData);
                                
                                // Update notification badge count
                                updateNotificationBadge();
                                
                                // Show success message
                                showSuccessMessage('‚úÖ Notification moved to history!');
                                
                            }, 500);
                        }
                    } else {
                        console.error('‚ùå Server error:', data.error);
                        alert('Error: ' + (data.error || 'Failed to mark as read'));
                        
                        // Restore button state
                        this.innerHTML = originalHTML;
                        this.disabled = false;
                    }
                })
                .catch(error => {
                    console.error('‚ùå Network error:', error);
                    alert('Network error. Please check your connection and try again.');
                    
                    // Restore button state
                    this.innerHTML = originalHTML;
                    this.disabled = false;
                });
            });
        });
        
        console.log('‚úÖ All notification buttons initialized!');
    }
    
    // Initialize Receive Order Message buttons
    function initializeReceiveOrderButtons() {
        console.log('üîß Initializing receive order message buttons...');
        
        const receiveOrderButtons = document.querySelectorAll('.receive-order-btn');
        console.log(`üìã Found ${receiveOrderButtons.length} receive order buttons`);
        
        receiveOrderButtons.forEach(function(button, index) {
            // Remove any existing listeners to prevent duplicates
            const newButton = button.cloneNode(true);
            button.parentNode.replaceChild(newButton, button);
            
            console.log(`üîß Setting up receive order button ${index + 1}`);
            
            newButton.addEventListener('click', function(event) {
                event.preventDefault();
                event.stopPropagation();
                
                console.log('üì¶ Receive order message button clicked!');
                
                const notificationId = this.getAttribute('data-notification-id');
                console.log('üìù Notification ID:', notificationId);
                
                if (!notificationId) {
                    alert('Error: No notification ID found');
                    return;
                }
                
                // Show confirmation dialog
                if (!confirm('Are you sure you want to acknowledge this order request? This will notify the admin that you have received the message.')) {
                    return;
                }
                
                // Get CSRF token
                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
                if (!csrfToken) {
                    alert('Error: CSRF token not found. Please refresh the page.');
                    return;
                }
                
                console.log('üîê CSRF token found');
                
                // Show loading state
                const originalHTML = this.innerHTML;
                this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Acknowledging...';
                this.disabled = true;
                
                console.log('üì° Sending order acknowledgment request...');
                
                // Create form data
                const formData = new FormData();
                formData.append('csrfmiddlewaretoken', csrfToken.value);
                formData.append('order_id', notificationId); // Use notification ID to find order
                
                // Send AJAX request to acknowledge order
                fetch('/acknowledge-order/', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => {
                    console.log('üì® Response status:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('üìä Response data:', data);
                    
                    if (data.success) {
                        console.log('‚úÖ Order acknowledgment successful!');
                        
                        // Find the notification card
                        const notificationCard = this.closest('.col-lg-6');
                        if (notificationCard) {
                            // Update the button to show acknowledged state
                            this.innerHTML = '<i class="fas fa-check-circle text-success"></i> Acknowledged';
                            this.className = 'btn btn-sm btn-success';
                            this.disabled = true;
                            
                            // Add acknowledgment badge to notification
                            const titleElement = notificationCard.querySelector('.card-title');
                            if (titleElement && !titleElement.querySelector('.acknowledgment-badge')) {
                                const ackBadge = document.createElement('span');
                                ackBadge.className = 'badge bg-success ms-2 acknowledgment-badge';
                                ackBadge.innerHTML = '<i class="fas fa-handshake me-1"></i>ACKNOWLEDGED';
                                titleElement.appendChild(ackBadge);
                            }
                            
                            // Show success message
                            showSuccessMessage('‚úÖ Order message acknowledged! Admin has been notified.');
                        }
                    } else {
                        console.error('‚ùå Server error:', data.error);
                        alert('Error: ' + (data.error || 'Failed to acknowledge order'));
                        
                        // Restore button state
                        this.innerHTML = originalHTML;
                        this.disabled = false;
                    }
                })
                .catch(error => {
                    console.error('‚ùå Network error:', error);
                    alert('Network error. Please check your connection and try again.');
                    
                    // Restore button state
                    this.innerHTML = originalHTML;
                    this.disabled = false;
                });
            });
        });
        
        console.log('‚úÖ All receive order buttons initialized!');
    }
    
    // Initialize Update Order Status buttons
    function initializeUpdateOrderButtons() {
        console.log('üöö Initializing update order status buttons...');
        
        const updateOrderButtons = document.querySelectorAll('.update-order-btn');
        console.log(`üìã Found ${updateOrderButtons.length} update order buttons`);
        
        updateOrderButtons.forEach(function(button, index) {
            // Remove any existing listeners to prevent duplicates
            const newButton = button.cloneNode(true);
            button.parentNode.replaceChild(newButton, button);
            
            console.log(`üîß Setting up update order button ${index + 1}`);
            
            newButton.addEventListener('click', function(event) {
                event.preventDefault();
                event.stopPropagation();
                
                console.log('üöö Update order status button clicked!');
                
                const notificationId = this.getAttribute('data-notification-id');
                const productName = this.getAttribute('data-product-name');
                console.log('üìù Notification ID:', notificationId, 'Product:', productName);
                
                if (!notificationId) {
                    alert('Error: No notification ID found');
                    return;
                }
                
                // Show confirmation dialog
                if (!confirm(`Mark order for "${productName}" as placed with supplier?\n\nThis will notify the admin that you have contacted the supplier and placed the order.`)) {
                    return;
                }
                
                // Get CSRF token
                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
                if (!csrfToken) {
                    alert('Error: CSRF token not found. Please refresh the page.');
                    return;
                }
                
                console.log('üîê CSRF token found');
                
                // Show loading state
                const originalHTML = this.innerHTML;
                this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Updating...';
                this.disabled = true;
                
                console.log('üì° Sending order status update request...');
                
                // We need to find the order ID from the notification
                // For now, we'll create a new endpoint to handle this
                fetch('/update-order-from-notification/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: `csrfmiddlewaretoken=${csrfToken.value}&notification_id=${notificationId}&status=ordered`
                })
                .then(response => {
                    console.log('üì® Response status:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('üìä Response data:', data);
                    
                    if (data.success) {
                        console.log('‚úÖ Order status update successful!');
                        
                        // Update the button to show success state
                        this.innerHTML = '<i class="fas fa-check-circle text-success"></i> Ordered';
                        this.className = 'btn btn-sm btn-success me-1';
                        this.disabled = true;
                        
                        // Show success message
                        showSuccessMessage('‚úÖ Order marked as placed with supplier! Admin has been notified.');
                    } else {
                        console.error('‚ùå Server error:', data.error);
                        alert('Error: ' + (data.error || 'Failed to update order status'));
                        
                        // Restore button state
                        this.innerHTML = originalHTML;
                        this.disabled = false;
                    }
                })
                .catch(error => {
                    console.error('‚ùå Network error:', error);
                    alert('Network error. Please check your connection and try again.');
                    
                    // Restore button state
                    this.innerHTML = originalHTML;
                    this.disabled = false;
                });
            });
        });
        
        console.log('‚úÖ All update order buttons initialized!');
    }
    
    // Initialize Stock Form with Product Information
    function initializeStockForm() {
        console.log('üì¶ Initializing stock form...');
        
        const productSelect = document.querySelector('#id_product');
        const productInfo = document.getElementById('productInfo');
        const currentStockSpan = document.getElementById('currentStock');
        const pendingOrdersSpan = document.getElementById('pendingOrders');
        const orderDetails = document.getElementById('orderDetails');
        
        if (!productSelect) {
            console.log('‚ùå Product select not found');
            return;
        }
        
        // Product data from Django context - using simple object
        const productData = {};
        
        productSelect.addEventListener('change', function() {
            const selectedProductId = this.value;
            
            if (selectedProductId && productData[selectedProductId]) {
                const product = productData[selectedProductId];
                
                // Show product info
                productInfo.style.display = 'block';
                
                // Update current stock
                currentStockSpan.textContent = product.stock + ' units';
                currentStockSpan.className = 'badge ms-1 ' + 
                    (product.stock < 10 ? 'bg-danger' : 
                     product.stock < 50 ? 'bg-warning' : 'bg-success');
                
                // Update pending orders
                pendingOrdersSpan.textContent = product.pendingOrders + ' orders';
                pendingOrdersSpan.className = 'badge ms-1 ' + 
                    (product.pendingOrders > 0 ? 'bg-warning text-dark' : 'bg-secondary');
                
                // Show order details if there are pending orders
                if (product.pendingOrders > 0) {
                    orderDetails.style.display = 'block';
                } else {
                    orderDetails.style.display = 'none';
                }
                
                console.log(`üìä Product info updated: ${product.name} - Stock: ${product.stock}, Orders: ${product.pendingOrders}`);
            } else {
                // Hide product info if no product selected
                productInfo.style.display = 'none';
            }
        });
        
        console.log('‚úÖ Stock form initialized!');
    }
    
    // Helper function to add notification to history tab
    function addToNotificationHistory(notificationData) {
        const historyTab = document.querySelector('#read-notifications');
        if (historyTab) {
            // Get current IST time
            const now = new Date();
            const istTime = new Date(now.getTime() + (5.5 * 60 * 60 * 1000)); // Add 5.5 hours for IST
            const currentTime = istTime.toLocaleString('en-US', {
                month: 'short',
                day: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                hour12: false,
                timeZone: 'Asia/Kolkata'
            });
            
            // Create history item HTML with priority colors
            const historyItem = document.createElement('div');
            historyItem.className = 'col-lg-6 mb-3';
            historyItem.innerHTML = `
                <div class="card h-100 border-start border-4 border-success opacity-75">
                    <div class="card-body p-3">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h6 class="card-title mb-0 text-muted">
                                <i class="fas fa-check-circle text-success me-1"></i>${notificationData.title}
                            </h6>
                            <span class="badge bg-success">READ</span>
                        </div>
                        <p class="card-text small text-muted mb-2">${notificationData.message}</p>
                        <div class="small text-muted">
                            <i class="fas fa-clock me-1"></i>Read: ${currentTime}
                        </div>
                    </div>
                </div>
            `;
            
            // Add to top of history tab
            const existingItems = historyTab.querySelectorAll('.col-lg-6');
            if (existingItems.length > 0) {
                historyTab.insertBefore(historyItem, existingItems[0]);
            } else {
                // Replace the "no history" message
                const noHistoryMsg = historyTab.querySelector('.text-center.py-5');
                if (noHistoryMsg) {
                    noHistoryMsg.remove();
                }
                const row = document.createElement('div');
                row.className = 'row';
                row.appendChild(historyItem);
                historyTab.appendChild(row);
            }
            
            // Update history tab count
            const historyTabButton = document.querySelector('#read-notifications-tab');
            if (historyTabButton) {
                const currentHistoryCount = historyTab.querySelectorAll('.col-lg-6').length;
                historyTabButton.innerHTML = `<i class="fas fa-check-circle me-1"></i>Read (${currentHistoryCount})`;
            }
        }
    }
    
    // Helper function to update notification badge
    function updateNotificationBadge() {
        const badge = document.querySelector('.position-absolute.badge.bg-danger');
        const newTab = document.querySelector('#new-notifications-tab');
        const mainTabBadge = document.querySelector('#notifications-tab .badge');
        
        // Count visible notifications in new tab
        const visibleNotifications = document.querySelectorAll('#new-notifications .col-lg-6:not([style*="display: none"])').length;
        
        if (badge) {
            if (visibleNotifications > 0) {
                badge.textContent = visibleNotifications;
                badge.style.display = 'block';
            } else {
                badge.style.display = 'none';
            }
        }
        
        // Update main tab badge
        if (mainTabBadge) {
            if (visibleNotifications > 0) {
                mainTabBadge.textContent = visibleNotifications;
                mainTabBadge.style.display = 'inline';
            } else {
                mainTabBadge.style.display = 'none';
            }
        }
        
        // Update new tab count
        if (newTab) {
            newTab.innerHTML = `<i class="fas fa-bell me-1"></i>New (${visibleNotifications})`;
        }
        
        // Show "no notifications" message if needed
        if (visibleNotifications === 0) {
            const newNotificationsTab = document.querySelector('#new-notifications .row');
            if (newNotificationsTab && !newNotificationsTab.querySelector('.text-center.py-5')) {
                newNotificationsTab.innerHTML = `
                    <div class="col-12">
                        <div class="text-center py-5">
                            <i class="fas fa-bell-slash fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">No new notifications</h5>
                            <p class="text-muted">You're all caught up!</p>
                        </div>
                    </div>
                `;
            }
        }
    }
    
    // Helper function to show success message
    function showSuccessMessage(message) {
        // Create a temporary success alert
        const alertDiv = document.createElement('div');
        alertDiv.className = 'alert alert-success alert-dismissible fade show position-fixed';
        alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        document.body.appendChild(alertDiv);
        
        // Auto-remove after 3 seconds
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.remove();
            }
        }, 3000);
    }
    
    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
            initializeNotificationButtons();
            initializeReceiveOrderButtons();
            initializeUpdateOrderButtons();
            initializeStockForm();
        });
    } else {
        initializeNotificationButtons();
        initializeReceiveOrderButtons();
        initializeUpdateOrderButtons();
        initializeStockForm();
    }
    
    console.log('üìú Notification system script loaded successfully');
})();

// Function to show full admin message
function showFullMessage(notificationId) {
    // Simple alert for now - can be enhanced with modal later
    alert(`Viewing full details for notification ID: ${notificationId}`);
    
    // Mark as read after viewing
    const readBtn = document.querySelector(`[data-notification-id="${notificationId}"].mark-read-btn`);
    if (readBtn) {
        setTimeout(() => {
            readBtn.click();
        }, 1000);
    }
}
</script>

<style>
/* Modern Tab Styling */
.nav-tabs .nav-link {
    border: none;
    border-radius: 0;
    color: #6c757d;
    font-weight: 500;
    padding: 12px 20px;
    transition: all 0.3s ease;
}

.nav-tabs .nav-link:hover {
    border-color: transparent;
    color: #0d6efd;
    background-color: #f8f9fa;
}

.nav-tabs .nav-link.active {
    color: #0d6efd;
    background-color: #fff;
    border-color: #dee2e6 #dee2e6 #fff;
    border-bottom: 2px solid #0d6efd;
}

/* Card Hover Effects */
.card {
    transition: all 0.3s ease;
    border: 1px solid #e9ecef;
}

.card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

/* Notification Cards */
.card.border-start {
    transition: all 0.3s ease;
}

.card.border-start:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 20px rgba(0,0,0,0.15);
}

/* Priority Badge Animations */
.badge {
    animation: pulse-priority 2s infinite;
}

@keyframes pulse-priority {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
}

/* Button Styling */
.btn-sm {
    transition: all 0.2s ease;
}

.btn-sm:hover {
    transform: scale(1.05);
}

.btn-sm:disabled {
    opacity: 0.6;
    transform: none;
}

/* Success message styling */
.alert.position-fixed {
    animation: slideInRight 0.3s ease-out;
    z-index: 9999;
}

@keyframes slideInRight {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

/* Table Styling */
.table th {
    border-top: none;
    font-weight: 600;
    color: #495057;
    background-color: #f8f9fa;
}

.table-hover tbody tr:hover {
    background-color: #f8f9fa;
}

/* Form Styling */
.form-control:focus {
    border-color: #0d6efd;
    box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
}

/* Responsive Design */
@media (max-width: 768px) {
    .nav-tabs .nav-link {
        padding: 8px 12px;
        font-size: 0.9rem;
    }
    
    .card-body {
        padding: 1rem;
    }
    
    .btn-sm {
        font-size: 0.8rem;
        padding: 0.25rem 0.5rem;
    }
}

/* Loading States */
.btn .fa-spinner {
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Empty State Styling */
.text-center.py-5 {
    color: #6c757d;
}

.text-center.py-5 i {
    opacity: 0.5;
}
</style>
{% endblock %}